<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>FocusFlow ‚Äî Settings</title>
  <meta name="color-scheme" content="light dark"/>
  <script>
    (function(){
      const hasToken = !!(localStorage.getItem('focusflow.auth.token') || sessionStorage.getItem('focusflow.auth.token'));
      if (!hasToken) location.replace('signin.html');
    })();
  </script>
  <link rel="stylesheet" href="auth.css"/>
  <style>
    body { padding: 16px; }
    .wrap { width: min(960px, 96vw); margin: 0 auto; display: grid; gap: 16px; }
    .header-bar { position: sticky; top: 12px; z-index: 85; display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .card { padding: clamp(18px, 3vw, 24px); }
    .grid { display:grid; gap:12px; }
    .two { grid-template-columns: 1fr 1fr; }
    @media (max-width: 720px){ .two{ grid-template-columns: 1fr; } }
    .row { display:flex; gap:10px; align-items:center; flex-wrap: wrap; }
    .note { font-size:12px; color:var(--muted); }
    .btn.primary{ background-image: var(--gradient); color:#fff; }

    /* Solid dropdown + overlay (no fuzzy overlap) */
    .overlay {
      position: fixed; inset: 0;
      background: rgba(0,0,0,.45);
      backdrop-filter: blur(2px);
      -webkit-backdrop-filter: blur(2px);
      z-index: 88;
      pointer-events: auto;
    }
    .hidden{ display:none !important; }

    .dropdown-wrap{ position:relative; }
    .dropdown-menu{
      position:absolute; top:44px; right:0;
      min-width:220px; max-height: min(60vh, 420px); overflow:auto;
      padding:10px; display:grid; gap:8px; z-index:90;
      background: rgba(20,24,36,.92); border-radius:14px;
      border:1px solid rgba(255,255,255,.18); box-shadow:0 24px 70px rgba(0,0,0,.5);
      backdrop-filter: none;
    }
    body.light .dropdown-menu { background: rgba(250,252,255,.98); }
    .dropdown-menu .item{ display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:10px; border:1px solid transparent; background:transparent; cursor:pointer; text-align:left; color:var(--text); }
    .dropdown-menu .item:hover{ background:var(--panel); border-color: rgba(255,255,255,.15); }
    body.light .dropdown-menu .item:hover{ background: rgba(0,0,0,.04); border-color: rgba(0,0,0,.08); }
    .dropdown-menu .item:focus { outline: 2px solid var(--ring); }
    .dropdown-menu hr{ border:0; height:1px; background:rgba(255,255,255,.15) }

    html.menu-open { overflow: hidden; }
  </style>
</head>
<body class="light">
  <div id="menu-overlay" class="overlay hidden" aria-hidden="true"></div>

  <header class="glass header-bar">
    <div class="dropdown-wrap">
      <button class="tab" id="menu-toggle" aria-haspopup="true" aria-expanded="false" aria-controls="dropdown-menu" aria-label="Open menu">‚ò∞</button>
      <nav class="dropdown-menu hidden" id="dropdown-menu" role="menu" aria-label="Main menu">
        <button class="item" role="menuitem" id="go-tasks">üóÇÔ∏è Tasks</button>
        <button class="item" role="menuitem" id="go-profile">üë§ Profile</button>
        <hr/>
        <button class="item" role="menuitem" id="logout-btn" style="color:#ef4444">üö™ Logout</button>
      </nav>
    </div>
    <h1 class="logo" style="margin:0">Focus<span>Flow</span> ‚Äî Settings</h1>
    <button id="theme-toggle" class="tab" title="Theme">üåô</button>
  </header>

  <main class="wrap">
    <section class="glass card" aria-labelledby="appearanceTitle">
      <h3 id="appearanceTitle" style="margin-top:0">Appearance</h3>
      <div class="grid two">
        <div class="field">
          <label for="theme">Theme</label>
          <select id="theme" class="input">
            <option value="light">Light</option>
            <option value="dark">Dark</option>
            <option value="amoled">AMOLED</option>
          </select>
          <div class="note">Applies across all pages.</div>
        </div>
        <div class="field">
          <label for="density">Density</label>
          <select id="density" class="input">
            <option value="cozy">Cozy (default)</option>
            <option value="compact">Compact</option>
          </select>
          <div class="note">Compact slightly reduces paddings on task rows.</div>
        </div>
      </div>
      <div class="row" style="justify-content:flex-end">
        <button id="apply-appearance" class="btn primary">Apply</button>
      </div>
    </section>

    <section class="glass card" aria-labelledby="dataTitle">
      <h3 id="dataTitle" style="margin-top:0">Data</h3>
      <div class="row">
        <button id="export-btn" class="btn">‚¨áÔ∏è Export tasks</button>
        <label class="btn">
          ‚¨ÜÔ∏è Import tasks
          <input id="import-input" type="file" accept="application/json" style="position:absolute;opacity:0;width:1px;height:1px;"/>
        </label>
        <button id="clear-tasks" class="btn destructive">üßπ Clear tasks</button>
      </div>
      <div class="divider" style="height:1px;background:rgba(255,255,255,.18);margin:12px 0"></div>
      <div class="row">
        <button id="delete-account" class="btn destructive">üóë Delete my account</button>
        <button id="signout" class="btn">üö™ Sign out</button>
      </div>
      <div class="note">Deleting your account removes your user from this browser only (demo local-first app).</div>
    </section>
  </main>

  <script src="auth.js"></script>
  <script>
    // ---- menu with overlay + focus trap ----
    (function initMenu(){
      const html = document.documentElement;
      const toggle  = document.getElementById('menu-toggle');
      const menu    = document.getElementById('dropdown-menu');
      const overlay = document.getElementById('menu-overlay');

      const focusables = () => Array.from(menu.querySelectorAll('button.item'));
      let lastFocused = null;

      function open(){
        lastFocused = document.activeElement;
        menu.classList.remove('hidden');
        overlay.classList.remove('hidden');
        toggle.setAttribute('aria-expanded','true');
        html.classList.add('menu-open');
        const f = focusables()[0]; if (f) f.focus();
      }
      function close(){
        menu.classList.add('hidden');
        overlay.classList.add('hidden');
        toggle.setAttribute('aria-expanded','false');
        html.classList.remove('menu-open');
        if (lastFocused) lastFocused.focus();
      }
      toggle.addEventListener('click', (e)=>{ e.stopPropagation(); menu.classList.contains('hidden')?open():close(); });
      overlay.addEventListener('click', close);
      document.addEventListener('keydown', e=>{
        if (menu.classList.contains('hidden')) return;
        if (e.key === 'Escape') { e.preventDefault(); return void close(); }
        if (e.key === 'Tab'){
          const els = focusables();
          if (!els.length) return;
          const i = els.indexOf(document.activeElement);
          if (e.shiftKey && (i === 0 || i === -1)) { els[els.length-1].focus(); e.preventDefault(); }
          else if (!e.shiftKey && i === els.length-1) { els[0].focus(); e.preventDefault(); }
        }
      });

      // routes
      document.getElementById('go-tasks').onclick   = ()=>{ close(); location.href='index.html'; };
      document.getElementById('go-profile').onclick = ()=>{ close(); location.href='profile.html'; };
      document.getElementById('logout-btn').onclick = ()=>{ close(); FocusAuth.Session.clear(); location.replace('signin.html'); };
    })();

    // ---- appearance ----
    const themeKey   = 'focusflow.theme';
    const densityKey = 'focusflow.ui.density';
    const tsel = document.getElementById('theme');
    const dsel = document.getElementById('density');

    tsel.value = localStorage.getItem(themeKey) || 'light';
    dsel.value = localStorage.getItem(densityKey) || 'cozy';

    document.getElementById('apply-appearance').onclick = ()=>{
      const t = tsel.value;
      localStorage.setItem(themeKey, t);
      document.body.className = t;
      localStorage.setItem(densityKey, dsel.value);
      alert('Appearance applied.');
    };

    // ---- data ops ----
    const storageKey = 'focusflow.v2';
    function exportData(){
      const data = localStorage.getItem(storageKey) || '{"tasks":[],"trash":[]}';
      const blob = new Blob([ data ], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = `focusflow-backup-${new Date().toISOString().slice(0,19)}.json`;
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }
    function importData(e){
      const file = e.target.files?.[0]; if (!file) return;
      const r = new FileReader();
      r.onload = ev => {
        try{
          const obj = JSON.parse(ev.target.result);
          if (!obj || !Array.isArray(obj.tasks)) throw new Error('Invalid file');
          localStorage.setItem(storageKey, JSON.stringify(obj));
          alert('Imported ‚úî');
        } catch { alert('Invalid backup file.'); }
      };
      r.readAsText(file);
      e.target.value = '';
    }
    function clearTasks(){
      if (!confirm('Clear all tasks and trash?')) return;
      localStorage.setItem(storageKey, JSON.stringify({tasks:[], trash:[], sortBy:'order', filter:'all', filterCategory:'All', filterPriority:'All'}));
      alert('Tasks cleared.');
    }
    document.getElementById('export-btn').onclick = exportData;
    document.getElementById('import-input').onchange = importData;
    document.getElementById('clear-tasks').onclick = clearTasks;

    // ---- account ----
    document.getElementById('delete-account').onclick = ()=>{
      if (!confirm('Delete your account from this browser? You will be signed out.')) return;
      const users = JSON.parse(localStorage.getItem('focusflow.auth.users')||'[]');
      const last  = localStorage.getItem('focusflow.auth.lastEmail');
      const i = users.findIndex(u=>u.email===last);
      if (i>-1) users.splice(i,1);
      localStorage.setItem('focusflow.auth.users', JSON.stringify(users));
      FocusAuth.Session.clear();
      alert('Account removed from this browser.');
      location.replace('signup.html');
    };
    document.getElementById('signout').onclick = ()=>{ FocusAuth.Session.clear(); location.replace('signin.html'); };
  </script>
</body>
</html>
