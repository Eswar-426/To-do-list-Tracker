<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FocusFlow ‚Äî Advanced Notes & Tasks</title>
  <meta name="color-scheme" content="light dark" />
  <!-- Auth Guard: only enforce on app page -->
  <script>
    (function authGuard(){
      const onAuthPage = /\/(signin|signup)\.html$/i.test(location.pathname);
      if (onAuthPage) return;
      const hasToken = !!(localStorage.getItem('focusflow.auth.token') || sessionStorage.getItem('focusflow.auth.token'));
      if (!hasToken) location.replace('signin.html');
    })();
  </script>
  <style>
    :root {
      --bg: #0e0f13;
      --panel: rgba(255,255,255,0.08);
      --panel-strong: rgba(255,255,255,0.12);
      --text: #e8eaf0;
      --muted: #a8afc3;
      --brandA: #7c3aed;
      --brandB: #06b6d4;
      --accent: #22d3ee;
      --ok: #10b981;
      --warn: #f59e0b;
      --bad: #ef4444;
      --ring: #60a5fa;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --glass: blur(10px) saturate(140%);
      --radius: 16px;
      --radius-sm: 12px;
      --radius-lg: 20px;
      --grid-gap: 14px;
      --transition: 180ms cubic-bezier(.2,.6,.2,1);
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans";
      --task-height: 64px;
      --chip: rgba(255,255,255,0.12);
      --chip-text: #f4f6ff;
      --scroll: rgba(255,255,255,.2);
      --gradient: linear-gradient(135deg, rgba(124,58,237,.35), rgba(6,182,212,.35));
      --gradient-strong: linear-gradient(135deg, rgba(124,58,237,.65), rgba(6,182,212,.65));
    }
    body.light {
      --bg: #f7f8fc;
      --panel: rgba(255,255,255,0.75);
      --panel-strong: rgba(255,255,255,0.9);
      --text: #142033;
      --muted: #5c6a85;
      --ring: #2563eb;
      --shadow: 0 10px 30px rgba(3,7,18,.08);
      --chip: rgba(0,0,0,0.06);
      --chip-text: #0c1322;
      --scroll: rgba(0,0,0,.25);
      --gradient: linear-gradient(135deg, rgba(124,58,237,.15), rgba(6,182,212,.15));
      --gradient-strong: linear-gradient(135deg, rgba(124,58,237,.35), rgba(6,182,212,.35));
    }
    body.amoled {
      --bg: #000;
      --panel: rgba(255,255,255,0.06);
      --panel-strong: rgba(255,255,255,0.08);
      --text: #f3f4f6;
      --muted: #9ca3af;
      --ring: #34d399;
      --shadow: 0 18px 50px rgba(0,0,0,.6);
      --chip: rgba(255,255,255,0.08);
      --chip-text: #f9fafb;
      --scroll: rgba(255,255,255,.25);
      --gradient: linear-gradient(135deg, rgba(6,182,212,.28), rgba(34,211,238,.28));
      --gradient-strong: linear-gradient(135deg, rgba(6,182,212,.55), rgba(34,211,238,.55));
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: var(--font);
      color: var(--text);
      background:
        radial-gradient(1200px 800px at 10% -10%, rgba(124,58,237,.15), transparent 60%),
        radial-gradient(1000px 600px at 110% 20%, rgba(6,182,212,.12), transparent 55%),
        linear-gradient(180deg, rgba(255,255,255,.02), transparent 40%),
        var(--bg);
      background-attachment: fixed;
    }
    ::selection { background: rgba(124,58,237,.35); color: #fff; }

    .glass { backdrop-filter: var(--glass); -webkit-backdrop-filter: var(--glass); background: var(--panel);
      box-shadow: var(--shadow); border: 1px solid rgba(255,255,255,0.14); border-radius: var(--radius); }

    /* Header */
    .header {
      position: sticky; top: 0; z-index: 60;
      margin: 16px; padding: 10px 14px;
      display: grid; grid-template-columns: 40px 1fr auto auto; gap: 10px; align-items: center;
      background-image: var(--gradient);
    }
    .menu-icon { font-size: 22px; cursor: pointer; user-select: none; }
    .logo { margin: 0; letter-spacing: .5px; font-weight: 800;
      background: linear-gradient(90deg, #7c3aed, #06b6d4, #22d3ee);
      -webkit-background-clip: text; background-clip: text; color: transparent; }
    .controls { display: flex; align-items: center; gap: 8px; }
    .btn {
      border: 0; border-radius: 12px; padding: 8px 12px; background: var(--panel-strong); color: var(--text);
      cursor: pointer; transition: transform var(--transition), background var(--transition), outline-color var(--transition);
      outline: 2px solid transparent;
    }
    .btn:hover { transform: translateY(-1px); }
    .btn-icon { width: 36px; height: 36px; display:grid; place-items:center; }
    .btn.primary { background-image: var(--gradient-strong); }
    .btn.destructive { background: rgba(239,68,68,.15); color: #ef4444; }
    .btn.ghost { background: transparent; border: 1px dashed rgba(255,255,255,.25); }
    .badge { padding: 4px 8px; border-radius: 999px; background: var(--chip); color: var(--chip-text); font-size: 12px;
      border: 1px solid rgba(255,255,255,.12); white-space: nowrap; }

    /* Dropdown + overlay (clear vision, no awkward overlaps) */
    .overlay {
      position: fixed; inset: 0; background: rgba(2,6,23,.35); backdrop-filter: blur(2px);
      -webkit-backdrop-filter: blur(2px); z-index: 55;
    }
    .hidden { display: none !important; }

    .dropdown-wrap { position: relative; } /* anchor for menu */
    .dropdown-menu {
      position: absolute; top: 46px; left: 0;
      width: 220px; padding: 8px;
      display: grid; gap: 8px;
      z-index: 70;
      background: var(--panel-strong);
      border-radius: 14px; border: 1px solid rgba(255,255,255,.16); box-shadow: var(--shadow);
    }
    .dropdown-menu .group-title { font-size: 12px; color: var(--muted); padding: 4px 6px; }
    .dropdown-menu .item {
      display: flex; align-items: center; gap: 10px;
      padding: 10px 12px; border-radius: 10px; background: transparent; border: 1px solid transparent;
      cursor: pointer; text-align: left;
    }
    .dropdown-menu .item:hover { background: var(--panel); border-color: rgba(255,255,255,.12); }
    .dropdown-menu hr { border: 0; height: 1px; background: rgba(255,255,255,.12); margin: 2px 0 6px; }

    /* Layout */
    main { display: grid; grid-template-columns: 300px 1fr; gap: var(--grid-gap); padding: 16px; }
    .sidebar { position: relative; padding: 14px; min-width: 240px; z-index: 10; overflow: hidden; }
    .resizer { position: absolute; top: 0; right: -8px; width: 16px; height: 100%; cursor: col-resize; opacity: .35; }

    .page { padding: 16px; background: var(--panel); border-radius: var(--radius); z-index: 10; }
    .top-row { display: grid; grid-template-columns: 1fr auto; align-items: center; margin-bottom: 10px; }
    #datetime { color: var(--muted); font-size: 14px; }

    .field, select, input[type="text"], input[type="datetime-local"] {
      height: 40px; border-radius: 12px; border: 1px solid rgba(255,255,255,.18);
      background: var(--panel-strong); padding: 0 12px; color: var(--text); outline: none;
      transition: box-shadow var(--transition), border-color var(--transition); min-width: 0; max-width: 100%;
    }
    input::placeholder { color: var(--muted); }
    .field:focus, select:focus, input:focus { box-shadow: 0 0 0 3px rgba(96,165,250,.25); border-color: var(--ring); }

    /* Task list: new structure (chips close to title) */
    #task-list { list-style:none; padding:0; margin: 14px 0 0; display: grid; gap: 10px; }
    .task {
      display:grid; grid-template-columns: 28px 24px 1fr 40px;
      align-items:center; gap: 10px; padding: 12px; border-radius: var(--radius-sm);
      background: linear-gradient(180deg, rgba(255,255,255,.04), transparent), var(--panel-strong);
      border: 1px solid rgba(255,255,255,.12); overflow:hidden; min-height: var(--task-height);
    }
    .drag-handle { cursor: grab; user-select: none; opacity: .7; }
    .task-title { font-weight: 700; overflow-wrap: anywhere; word-break: break-word; min-width: 0; }
    .task-title.completed { text-decoration: line-through; color: var(--muted); }

    .task-body { display: grid; gap: 6px; align-items:center; }
    .title-row { display:flex; gap: 10px; align-items: center; flex-wrap: wrap; min-width: 0; }
    .chip-row { display:flex; gap: 8px; align-items:center; flex-wrap: wrap; }

    .chip, .prio, .badge.category {
      display:inline-flex; align-items:center; gap:6px; padding: 6px 10px;
      border-radius: 999px; font-size: 12px; background: var(--chip);
      border: 1px solid rgba(255,255,255,.12); color: var(--chip-text);
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%;
      height: 28px;
    }
    .chip .icon { opacity: .85; }

    /* Due chip input (small, inline) */
    .chip-input {
      height: 28px; padding: 0 8px; border-radius: 999px; background: var(--panel);
      border: 1px dashed rgba(255,255,255,.18); color: var(--text); width: auto; min-width: 180px;
    }

    .badge.category.Work { background: rgba(99,102,241,.18); color: #cbd0ff;}
    .badge.category.Personal { background: rgba(14,165,233,.18); color:#cfeaff;}
    .badge.category.Urgent { background: rgba(239,68,68,.18); color:#ffc9c9;}
    .badge.category.Study { background: rgba(16,185,129,.18); color:#c8fde9;}

    .prio { border: 1px solid rgba(255,255,255,.16);}
    .prio.Low { background: rgba(16,185,129,.14); color:#b6f5df;}
    .prio.Medium { background: rgba(245,158,11,.14); color:#ffe1b3;}
    .prio.High { background: rgba(239,68,68,.14); color:#ffc9c9;}

    .actions { display:flex; gap:6px; justify-content:flex-end; }
    .checkbox { appearance: none; width: 18px; height: 18px; border-radius: 6px; border:1px solid rgba(255,255,255,.25);
      display:grid; place-items:center; cursor:pointer; }
    .checkbox:checked { background: linear-gradient(135deg,#22d3ee,#7c3aed); border-color: transparent; }

    /* Sidebar groups */
    .side-group { margin-bottom: 14px; }
    .side-title { font-weight: 700; margin-bottom: 8px; font-size: 14px; color: var(--muted); }
    .side-row { display: grid; grid-template-columns: 1fr; gap: 8px; }
    .row { display:flex; gap:8px; align-items:center; }

    .footer { margin: 16px; padding: 10px 14px; display:flex; align-items:center; justify-content:space-between; background-image: var(--gradient); }

    .snackbar { position: fixed; left: 50%; bottom: 20px; transform: translateX(-50%);
      background: var(--panel-strong); padding: 10px 14px; border-radius: 12px; display:flex; gap: 10px; align-items:center;
      box-shadow: var(--shadow); border: 1px solid rgba(255,255,255,.16); z-index: 80; }

    *{ scrollbar-width: thin; scrollbar-color: var(--scroll) transparent; }
    *::-webkit-scrollbar { height: 10px; width: 10px; }
    *::-webkit-scrollbar-thumb { background: var(--scroll); border-radius: 999px; }
    *::-webkit-scrollbar-track { background: transparent; }

    /* ---- Responsive & collision fixes ---- */
    .sidebar .side-row > * { min-width: 0; max-width: 100%; }
    .sidebar .side-row .row { display:flex; flex-wrap: wrap; gap: 8px; }
    .sidebar .side-row .row > * { flex: 1 1 auto; min-width: 0; }
    @media (max-width: 1280px) {
      main { grid-template-columns: 280px 1fr; gap: 12px; }
      .sidebar .side-row .row select,
      .sidebar .side-row .row input[type="datetime-local"] { flex: 1 1 160px; }
      #add-btn { flex: 0 0 auto; }
    }
    @media (max-width: 980px) {
      main { grid-template-columns: 1fr; }
      .sidebar { margin-bottom: 12px; }
    }
    @media (max-width: 640px) {
      .task { grid-template-columns: 24px 22px 1fr 32px; }
      .chip-input { min-width: 140px; }
    }
    /* ===== Dashboard-specific: dropdown layering & contrast ===== */
#menu-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.45);
  backdrop-filter: blur(2px);
  -webkit-backdrop-filter: blur(2px);
  z-index: 90;
  pointer-events: auto;
}
.dropdown-menu {
  z-index: 110 !important;
  position: absolute;
  top: 46px;
  left: 0;
  min-width: 220px;
  max-height: min(60vh, 420px);
  overflow: auto;
  padding: 10px;
  border-radius: 14px;
  box-shadow: 0 24px 70px rgba(0,0,0,.35);
  backdrop-filter: none !important;
  -webkit-backdrop-filter: none !important;
  mix-blend-mode: normal;
  background: rgba(250,252,255,.98);
  color: #0f172a;
  border: 1px solid rgba(0,0,0,.08);
}
body:not(.light) .dropdown-menu {
  background: rgba(20,24,36,.96);
  color: #e5e7eb;
  border-color: rgba(255,255,255,.14);
}
.dropdown-menu .item {
  color: inherit !important;
  opacity: 1 !important;
  filter: none !important;
  text-shadow: none !important;
}
.header { z-index: 100; }
html.menu-open { overflow: hidden; }

  </style>
</head>
<body class="light">
  <!-- Dim overlay for dropdown clarity -->
  <div id="menu-overlay" class="overlay hidden" aria-hidden="true"></div>

  <header class="glass header" role="banner">
    <div class="dropdown-wrap">
      <button class="menu-icon btn btn-icon" id="menu-toggle" aria-haspopup="true" aria-expanded="false" aria-controls="dropdown-menu" title="Menu">‚ò∞</button>
      <nav class="dropdown-menu hidden" id="dropdown-menu" aria-label="Main menu">
        <div class="group-title">Quick</div>
        <button class="item" id="menu-tasks">Tasks</button>
        <button class="item" id="menu-profile">Profile</button>
        <button class="item" id="menu-settings">Settings</button>
        <hr />
        <button id="logout-btn" class="item" style="color:#ef4444">Logout</button>
      </nav>
    </div>

    <h2 class="logo" aria-label="FocusFlow">Focus<span>Flow</span></h2>

    <div class="controls">
      <button id="export-btn" class="btn" title="Export data">‚¨áÔ∏è Export</button>
      <label class="btn" title="Import data">
        ‚¨ÜÔ∏è Import
        <input id="import-input" type="file" accept="application/json" class="sr-only" style="position:absolute;opacity:0;width:1px;height:1px;"/>
      </label>
      <button id="theme-toggle" class="btn btn-icon" aria-label="Toggle theme" title="Toggle theme">üåô</button>
    </div>
  </header>

  <main>
    <aside class="glass sidebar" id="sidebar" aria-label="Filters">
      <div class="resizer" id="resizer" title="Drag to resize"></div>

      <div class="side-group">
        <div class="side-title">Quick Add</div>
        <div class="side-row">
          <input type="text" id="task-input" class="field" placeholder="Add a new task..." />
          <div class="row">
            <input type="datetime-local" id="due-date" class="field" />
            <select id="category" class="field" title="Category">
              <option value="Work">Work</option>
              <option value="Personal">Personal</option>
              <option value="Urgent">Urgent</option>
              <option value="Study">Study</option>
            </select>
          </div>
          <div class="row">
            <select id="priority" class="field" title="Priority">
              <option value="Medium">Priority: Medium</option>
              <option value="Low">Priority: Low</option>
              <option value="High">Priority: High</option>
            </select>
            <button id="add-btn" class="btn primary" title="Add task">‚ûï Add</button>
          </div>
        </div>
      </div>

      <div class="side-group">
        <div class="side-title">Filters</div>
        <div class="side-row">
          <input type="text" id="search" class="field" placeholder="Search tasks..." />
          <select id="filter" class="field">
            <option value="all">Show: All</option>
            <option value="pending">Show: Pending</option>
            <option value="completed">Show: Completed</option>
          </select>
          <select id="filter-category" class="field">
            <option value="All">Category: All</option>
            <option>Work</option><option>Personal</option><option>Urgent</option><option>Study</option>
          </select>
          <select id="filter-priority" class="field">
            <option value="All">Priority: All</option>
            <option>High</option><option>Medium</option><option>Low</option>
          </select>
          <select id="sort-by" class="field">
            <option value="order">Sort: Manual</option>
            <option value="dueAsc">Sort: Due ‚Üë</option>
            <option value="dueDesc">Sort: Due ‚Üì</option>
            <option value="createdDesc">Sort: Newest</option>
            <option value="createdAsc">Sort: Oldest</option>
            <option value="priorityHigh">Sort: Priority</option>
          </select>
        </div>
      </div>

      <div class="side-group">
        <div class="side-title">Bulk Actions</div>
        <div class="row">
          <button id="complete-selected" class="btn">‚úî Mark Done</button>
          <button id="delete-selected" class="btn destructive">üóë Delete</button>
        </div>
        <div class="row" style="margin-top:8px">
          <button id="undo-btn" class="btn ghost">‚Ü© Undo</button>
          <button id="redo-btn" class="btn ghost">‚Ü™ Redo</button>
          <button id="trash-btn" class="btn">üß∫ Trash</button>
        </div>
        <small class="muted">Tip: Press ‚Äú/‚Äù to search, ‚ÄúN‚Äù to add.</small>
      </div>
    </aside>

    <section id="tasks-page" class="page" role="region" aria-label="Tasks">
      <div class="top-row">
        <h3 style="margin:0">Your Tasks</h3>
        <p id="datetime" aria-live="polite"></p>
      </div>
      <ul id="task-list" aria-live="polite" aria-label="Task list"></ul>
    </section>
  </main>

  <footer class="footer glass" role="contentinfo">
    <p style="margin:0">¬© 2025 FocusFlow ‚Äî Designed by Eswar ‚ö°</p>
    <small>Gradient vibes + glass UI + offline-friendly</small>
  </footer>

  <div id="snackbar" class="snackbar hidden" role="status" aria-live="polite"></div>

  <dialog id="trash-modal" class="glass" style="border:none; padding:16px; max-width:640px; width:90%;">
    <header class="row" style="justify-content:space-between;margin-bottom:10px">
      <h3 style="margin:0">Trash</h3>
      <button id="trash-close" class="btn btn-icon" aria-label="Close">‚úñ</button>
    </header>
    <div id="trash-list" style="display:grid;gap:8px;"></div>
    <footer class="row" style="justify-content:flex-end;margin-top:10px">
      <button id="trash-empty" class="btn destructive">Empty Trash</button>
    </footer>
  </dialog>

  <!-- ========= App Script ========= -->
  <script>
    const $ = (sel, ctx = document) => ctx.querySelector(sel);
    const $$ = (sel, ctx = document) => Array.from(ctx.querySelectorAll(sel));
    const byId = id => document.getElementById(id);
    const nowISO = () => new Date().toISOString();
    const safeJSON = {
      parse: (s, fallback) => { try { return JSON.parse(s); } catch { return fallback; } },
      stringify: (v) => JSON.stringify(v, null, 2)
    };
    const clamp = (n, min, max) => Math.max(min, Math.min(max, n));
    const storageKey = 'focusflow.v2';
    const themeKey = 'focusflow.theme';

    let snackTimer = null;
    function toast(html, ms = 3000) {
      const bar = byId('snackbar');
      bar.innerHTML = html;
      bar.classList.remove('hidden');
      clearTimeout(snackTimer);
      snackTimer = setTimeout(() => bar.classList.add('hidden'), ms);
    }

    const state = {
      tasks: [],
      trash: [],
      selection: new Set(),
      undo: [],
      redo: [],
      sortBy: 'order',
      filter: 'all',
      filterCategory: 'All',
      filterPriority: 'All',
      search: ''
    };

    function load() {
      const raw = localStorage.getItem(storageKey);
      const data = safeJSON.parse(raw, null);
      if (!data) return save();
      if (!Array.isArray(data.tasks)) { data.tasks = []; }
      if (!Array.isArray(data.trash)) { data.trash = []; }
      Object.assign(state, data);
      render();
    }
    function save() {
      localStorage.setItem(storageKey, safeJSON.stringify({
        tasks: state.tasks,
        trash: state.trash,
        sortBy: state.sortBy,
        filter: state.filter,
        filterCategory: state.filterCategory,
        filterPriority: state.filterPriority
      }));
    }

    function applyTheme(t) {
      document.body.classList.remove('light','amoled','dark');
      document.body.classList.add(t);
      byId('theme-toggle').textContent = t === 'light' ? 'üåô' : (t === 'amoled' ? 'üí°' : '‚òÄÔ∏è');
      localStorage.setItem(themeKey, t);
    }
    function initTheme() {
      const t = localStorage.getItem(themeKey) || 'light';
      applyTheme(t);
    }

    const uid = () => Math.random().toString(36).slice(2) + Date.now().toString(36);
    function createTask({title, due=null, category='Work', priority='Medium'}) {
      return {
        id: uid(),
        title: title.trim(),
        completed: false,
        due: due || null,
        category,
        priority,
        createdAt: nowISO(),
        updatedAt: nowISO(),
        order: state.tasks.length ? Math.max(...state.tasks.map(t=>t.order||0))+1 : 1
      };
    }

    function pushUndo(action) { state.undo.push(action); state.redo = []; }
    function undo() {
      const a = state.undo.pop(); if (!a) return;
      if (a.type === 'add') {
        const idx = state.tasks.findIndex(t=>t.id===a.task.id);
        if (idx>-1) state.tasks.splice(idx,1);
      } else if (a.type === 'delete') {
        state.tasks.push(a.task);
      } else if (a.type === 'update') {
        const i = state.tasks.findIndex(t=>t.id===a.after.id);
        if (i>-1) state.tasks[i] = a.before;
      } else if (a.type === 'completeToggle') {
        const t = state.tasks.find(x=>x.id===a.id); if (t) t.completed = !t.completed;
      } else if (a.type === 'reorder') {
        state.tasks = a.before;
      } else if (a.type === 'trash-delete') {
        state.trash.push(a.task);
      } else if (a.type === 'trash-restore') {
        const i = state.trash.findIndex(t=>t.id===a.task.id);
        if (i>-1) state.trash.splice(i,1);
        state.tasks.push(a.task);
      }
      state.redo.push(a);
      save(); render();
    }
    function redo() {
      const a = state.redo.pop(); if (!a) return;
      if (a.type === 'add') {
        state.tasks.push(a.task);
      } else if (a.type === 'delete') {
        const idx = state.tasks.findIndex(t=>t.id===a.task.id);
        if (idx>-1) state.tasks.splice(idx,1);
      } else if (a.type === 'update') {
        const i = state.tasks.findIndex(t=>t.id===a.before.id);
        if (i>-1) state.tasks[i] = a.after;
      } else if (a.type === 'completeToggle') {
        const t = state.tasks.find(x=>x.id===a.id); if (t) t.completed = !t.completed;
      } else if (a.type === 'reorder') {
        state.tasks = a.after;
      } else if (a.type === 'trash-delete') {
        const i = state.trash.findIndex(t=>t.id===a.task.id);
        if (i>-1) state.trash.splice(i,1);
      } else if (a.type === 'trash-restore') {
        const i = state.tasks.findIndex(t=>t.id===a.task.id);
        if (i>-1) state.tasks.splice(i,1);
        state.trash.push(a.task);
      }
      state.undo.push(a);
      save(); render();
    }

    function addTaskFromUI() {
      const title = byId('task-input').value.trim();
      const due = byId('due-date').value || null;
      const category = byId('category').value;
      const priority = byId('priority').value;
      if (!title) { toast('‚ö†Ô∏è Please enter a task title.'); return; }
      const task = createTask({title, due, category, priority});
      state.tasks.push(task);
      pushUndo({type:'add', task});
      save(); render();
      byId('task-input').value = '';
      byId('due-date').value = '';
      toast('‚úÖ Task added. Press ‚Ü© Undo if needed.', 2200);
    }
    function deleteTask(id) {
      const idx = state.tasks.findIndex(t=>t.id===id);
      if (idx===-1) return;
      const [task] = state.tasks.splice(idx,1);
      state.trash.push(task);
      pushUndo({type:'delete', task});
      save(); render();
      toast(`üóë Moved to Trash. <button class="btn ghost" onclick="window.__undo()">Undo</button>`, 3500);
    }
    function updateTask(id, patch) {
      const i = state.tasks.findIndex(t=>t.id===id);
      if (i===-1) return;
      const before = {...state.tasks[i]};
      state.tasks[i] = {...state.tasks[i], ...patch, updatedAt: nowISO()};
      pushUndo({type:'update', before, after: {...state.tasks[i]}});
      save(); render();
    }
    function toggleComplete(id) {
      const t = state.tasks.find(x=>x.id===id); if (!t) return;
      t.completed = !t.completed; t.updatedAt = nowISO();
      pushUndo({type:'completeToggle', id});
      save(); render();
    }

    function bulkComplete() {
      if (state.selection.size === 0) return toast('Select tasks first.');
      [...state.selection].forEach(id => {
        const t = state.tasks.find(x=>x.id===id); if (t) t.completed = true;
      });
      pushUndo({type:'update', before: null, after: null});
      state.selection.clear();
      save(); render(); toast('‚úî Marked selected as done.');
    }
    function bulkDelete() {
      if (state.selection.size === 0) return toast('Select tasks first.');
      [...state.selection].forEach(id => deleteTask(id));
      state.selection.clear();
      render();
    }

    function filteredTasks() {
      let list = [...state.tasks];
      if (state.filter !== 'all') {
        list = list.filter(t => state.filter === 'completed' ? t.completed : !t.completed);
      }
      if (state.filterCategory !== 'All') list = list.filter(t => t.category === state.filterCategory);
      if (state.filterPriority !== 'All') list = list.filter(t => t.priority === state.filterPriority);
      if (state.search) {
        const q = state.search.toLowerCase();
        list = list.filter(t => t.title.toLowerCase().includes(q));
      }
      const prioRank = {High: 3, Medium: 2, Low: 1};
      if (state.sortBy === 'dueAsc') list.sort((a,b) => (a.due||'') > (b.due||'') ? 1 : -1);
      if (state.sortBy === 'dueDesc') list.sort((a,b) => (a.due||'') < (b.due||'') ? 1 : -1);
      if (state.sortBy === 'createdDesc') list.sort((a,b)=> (b.createdAt||'').localeCompare(a.createdAt||''));
      if (state.sortBy === 'createdAsc') list.sort((a,b)=> (a.createdAt||'').localeCompare(b.createdAt||''));
      if (state.sortBy === 'priorityHigh') list.sort((a,b)=> (prioRank[b.priority]-prioRank[a.priority]));
      if (state.sortBy === 'order') list.sort((a,b)=> (a.order||0)-(b.order||0));
      return list;
    }

    // New task row layout: [drag] [checkbox] [title + chips] [actions]
    function taskRow(t) {
      const li = document.createElement('li');
      li.className = 'task';
      li.draggable = true;
      li.dataset.id = t.id;

      const drag = document.createElement('div');
      drag.className = 'drag-handle'; drag.textContent = '‚†ø'; drag.title = 'Drag to reorder';

      const check = document.createElement('input');
      check.type = 'checkbox'; check.className = 'checkbox';
      check.checked = t.completed;
      check.ariaLabel = 'Mark complete';

      // body (title + chips)
      const body = document.createElement('div');
      body.className = 'task-body';

      const titleRow = document.createElement('div');
      titleRow.className = 'title-row';

      const title = document.createElement('div');
      title.className = 'task-title' + (t.completed ? ' completed':'');
      title.textContent = t.title;
      title.title = t.title;

      // inline edit on click
      title.addEventListener('click', () => {
        const input = document.createElement('input');
        input.className = 'field';
        input.style.height = '32px';
        input.value = t.title;
        title.replaceWith(input);
        input.focus(); input.select();
        const commit = (ok) => {
          if (!ok) { render(); return; }
          const val = input.value.trim();
          if (!val) return toast('‚ö†Ô∏è Title cannot be empty.');
          updateTask(t.id, {title: val});
        };
        input.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') commit(true);
          if (e.key === 'Escape') commit(false);
        });
        input.addEventListener('blur', () => commit(true));
      });

      titleRow.appendChild(title);

      const chipRow = document.createElement('div');
      chipRow.className = 'chip-row';

      // Due as small input chip
      const dueWrap = document.createElement('div');
      dueWrap.className = 'chip';
      const dueIcon = document.createElement('span'); dueIcon.className='icon'; dueIcon.textContent='üìÖ';
      const dueInput = document.createElement('input');
      dueInput.type = 'datetime-local'; dueInput.value = t.due || '';
      dueInput.className = 'chip-input';
      dueInput.addEventListener('change', () => updateTask(t.id, {due: dueInput.value || null}));
      dueWrap.append(dueIcon, dueInput);

      const cat = document.createElement('span');
      cat.className = 'badge category ' + t.category;
      cat.textContent = t.category;

      const pr = document.createElement('span');
      pr.className = 'prio ' + t.priority;
      pr.textContent = t.priority;

      chipRow.append(dueWrap, cat, pr);

      body.append(titleRow, chipRow);

      const actions = document.createElement('div'); actions.className = 'actions';
      const sel = document.createElement('input');
      sel.type = 'checkbox'; sel.title='Select for bulk';
      sel.addEventListener('change', ()=> { if (sel.checked) state.selection.add(t.id); else state.selection.delete(t.id); });
      const del = document.createElement('button'); del.className='btn btn-icon'; del.title='Delete';
      del.textContent='üóë'; del.addEventListener('click', ()=> deleteTask(t.id));
      actions.append(sel, del);

      check.addEventListener('change', ()=> toggleComplete(t.id));
      li.append(drag, check, body, actions);
      return li;
    }

    function render() {
      const ul = byId('task-list');
      ul.innerHTML = '';
      filteredTasks().forEach(t => ul.appendChild(taskRow(t)));
      save();
    }

    // Drag & drop
    let dragId = null;
    function dndInit() {
      const ul = byId('task-list');
      ul.addEventListener('dragstart', e => {
        const li = e.target.closest('.task'); if (!li) return;
        dragId = li.dataset.id; li.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
      });
      ul.addEventListener('dragend', e => {
        const li = e.target.closest('.task'); if (li) li.classList.remove('dragging');
        dragId = null;
      });
      ul.addEventListener('dragover', e => {
        e.preventDefault();
        const after = getDragAfterElement(ul, e.clientY);
        const dragging = $('.task.dragging');
        if (!dragging) return;
        if (after == null) ul.appendChild(dragging);
        else ul.insertBefore(dragging, after);
      });
      ul.addEventListener('drop', () => {
        const before = [...state.tasks];
        $$('.task', ul).forEach((li, i) => {
          const t = state.tasks.find(x=>x.id===li.dataset.id);
          if (t) t.order = i+1;
        });
        pushUndo({type:'reorder', before, after: [...state.tasks]});
        save();
      });
    }
    function getDragAfterElement(container, y) {
      const els = [...container.querySelectorAll('.task:not(.dragging)')];
      return els.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        if (offset < 0 && offset > closest.offset) {
          return { offset, element: child };
        } else {
          return closest;
        }
      }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    // Sidebar resizer
    function initResizer() {
      const sidebar = byId('sidebar');
      const resizer = byId('resizer');
      let startX = 0; let startW = sidebar.offsetWidth;
      let dragging = false;
      const onMove = (e) => {
        if (!dragging) return;
        const dx = e.clientX - startX;
        const w = clamp(startW + dx, 240, 520);
        sidebar.style.width = w + 'px';
      };
      resizer.addEventListener('mousedown', (e) => {
        dragging = true; startX = e.clientX; startW = sidebar.offsetWidth;
        document.body.style.cursor = 'col-resize';
        window.addEventListener('mousemove', onMove);
        window.addEventListener('mouseup', () => {
          dragging = false; document.body.style.cursor = '';
          window.removeEventListener('mousemove', onMove);
        }, { once:true });
      });
    }

    // Menu (with overlay for clarity)
    function initMenu() {
      const toggle = byId('menu-toggle');
      const menu = byId('dropdown-menu');
      const overlay = byId('menu-overlay');
      const open = () => {
        menu.classList.remove('hidden');
        overlay.classList.remove('hidden');
        toggle.setAttribute('aria-expanded','true');
      };
      const close = () => {
        menu.classList.add('hidden');
        overlay.classList.add('hidden');
        toggle.setAttribute('aria-expanded','false');
      };
      toggle.addEventListener('click', (e) => {
        e.stopPropagation();
        menu.classList.contains('hidden') ? open() : close();
      });
      overlay.addEventListener('click', close);
      document.addEventListener('keydown', (e)=> { if (e.key==='Escape') close(); });

     
      $('#menu-tasks').addEventListener('click', () => { close(); location.href = 'index.html'; });
      $('#menu-profile').addEventListener('click', () => { close(); location.href = 'profile.html'; });
      $('#menu-settings').addEventListener('click', () => { close(); location.href = 'settings.html'; });
      $('#logout-btn').addEventListener('click', () => { toast('üö™ Logging out‚Ä¶ (handled below)'); close(); });
    }

    function initClock() {
      const el = byId('datetime');
      const tick = () => {
        const d = new Date();
        const s = d.toLocaleString([], { dateStyle:'full', timeStyle:'medium' });
        el.textContent = s;
      };
      tick(); setInterval(tick, 1000);
    }
    function initThemeToggle() {
      byId('theme-toggle').addEventListener('click', () => {
        const current = document.body.classList.contains('light') ? 'light'
                        : document.body.classList.contains('amoled') ? 'amoled'
                        : 'dark';
        const next = current === 'light' ? 'dark' : (current === 'dark' ? 'amoled' : 'light');
        applyTheme(next);
      });
    }

    function initEvents() {
      byId('add-btn').addEventListener('click', addTaskFromUI);
      byId('task-input').addEventListener('keydown', e => { if (e.key==='Enter') addTaskFromUI(); });

      byId('filter').addEventListener('change', e => { state.filter = e.target.value; render(); });
      byId('filter-category').addEventListener('change', e => { state.filterCategory = e.target.value; render(); });
      byId('filter-priority').addEventListener('change', e => { state.filterPriority = e.target.value; render(); });
      byId('sort-by').addEventListener('change', e => { state.sortBy = e.target.value; render(); });
      byId('search').addEventListener('input', e => { state.search = e.target.value.trim(); render(); });

      byId('complete-selected').addEventListener('click', bulkComplete);
      byId('delete-selected').addEventListener('click', bulkDelete);
      byId('undo-btn').addEventListener('click', undo); window.__undo = undo;
      byId('redo-btn').addEventListener('click', redo);

      byId('trash-btn').addEventListener('click', openTrash);
      byId('trash-close').addEventListener('click', closeTrash);
      byId('trash-empty').addEventListener('click', emptyTrash);

      byId('export-btn').addEventListener('click', exportData);
      byId('import-input').addEventListener('change', importData);

      window.addEventListener('keydown', (e) => {
        if (e.key === '/' && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {
          e.preventDefault(); byId('search').focus();
        }
        if (e.key.toLowerCase() === 'n' && !e.metaKey && !e.ctrlKey && document.activeElement.tagName !== 'INPUT') {
          e.preventDefault(); byId('task-input').focus();
        }
        if (e.ctrlKey && e.key.toLowerCase() === 'z') { e.preventDefault(); undo(); }
        if ((e.ctrlKey && e.shiftKey && e.key.toLowerCase() === 'z') || (e.ctrlKey && e.key.toLowerCase() === 'y')) { e.preventDefault(); redo(); }
      });
    }

    function openTrash() {
      const dlg = byId('trash-modal');
      const list = byId('trash-list');
      list.innerHTML = '';
      state.trash.forEach(t => {
        const row = document.createElement('div');
        row.className = 'task';
        row.style.gridTemplateColumns = '1fr 160px 120px 180px';
        row.innerHTML = `
          <div class="task-title">${t.title}</div>
          <span class="badge category ${t.category}">${t.category}</span>
          <span class="prio ${t.priority}">${t.priority}</span>
          <div class="actions">
            <button class="btn">Restore</button>
            <button class="btn destructive">Delete</button>
          </div>
        `;
        const [restoreBtn, delBtn] = row.querySelectorAll('button');
        restoreBtn.addEventListener('click', () => { restoreFromTrash(t.id); openTrash(); });
        delBtn.addEventListener('click', () => { permDeleteFromTrash(t.id); openTrash(); });
        list.appendChild(row);
      });
      dlg.showModal();
    }
    function closeTrash() { byId('trash-modal').close(); }
    function restoreFromTrash(id) {
      const i = state.trash.findIndex(t=>t.id===id); if (i===-1) return;
      const [task] = state.trash.splice(i,1);
      state.tasks.push(task);
      pushUndo({type:'trash-restore', task});
      save(); render(); toast('‚ôªÔ∏è Restored.');
    }
    function permDeleteFromTrash(id) {
      const i = state.trash.findIndex(t=>t.id===id); if (i===-1) return;
      const [task] = state.trash.splice(i,1);
      pushUndo({type:'trash-delete', task});
      save(); render(); toast('üßπ Permanently deleted.');
    }
    function emptyTrash() {
      if (!confirm('Empty trash permanently?')) return;
      state.trash = []; save(); toast('üß∫ Trash emptied.');
      openTrash();
    }

    function exportData() {
      const blob = new Blob([ JSON.stringify({ ...state, undo:[], redo:[] }, null, 2) ], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `focusflow-backup-${new Date().toISOString().slice(0,19)}.json`;
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      toast('‚¨áÔ∏è Exported.');
    }
    function importData(e) {
      const file = e.target.files?.[0]; if (!file) return;
      const reader = new FileReader();
      reader.onload = (ev) => {
        const data = safeJSON.parse(ev.target.result, null);
        if (!data || !Array.isArray(data.tasks)) return toast('Invalid backup file.');
        state.tasks = data.tasks || [];
        state.trash = data.trash || [];
        save(); render(); toast('‚¨ÜÔ∏è Imported.');
      };
      reader.readAsText(file);
      e.target.value = '';
    }

    initTheme();
    initMenu();
    initClock();
    initThemeToggle();
    initEvents();
    dndInit();
    initResizer();
    load();

    if (state.tasks.length === 0) {
      ['Finish UI polish','Prepare internship demo','Study DSA 1 hr','Gym: push day','Call mentor about project']
        .forEach((t,i)=> state.tasks.push(createTask({
          title: t, category: ['Work','Work','Study','Personal','Personal'][i],
          priority: ['High','Medium','High','Low','Medium'][i],
          due: i<3 ? new Date(Date.now()+ (i+1)*86400000).toISOString().slice(0,16) : null
        })));
      save(); render();
    }
  </script>

  <!-- Real Logout + Welcome Badge -->
  <script>
    (function wireLogout(){
      const btn = document.getElementById('logout-btn');
      if (!btn) return;
      btn.addEventListener('click', () => {
        if (!confirm('Log out of FocusFlow?')) return;
        sessionStorage.removeItem('focusflow.auth.token');
        localStorage.removeItem('focusflow.auth.token');
        location.replace('signin.html');
      });
    })();
    (function showUser(){
      try {
        const users = JSON.parse(localStorage.getItem('focusflow.auth.users')||'[]');
        const last = localStorage.getItem('focusflow.auth.lastEmail');
        const u = users.find(x=>x.email===last);
        if (!u) return;
        const header = document.querySelector('header.header .controls');
        if (!header) return;
        const badge = document.createElement('span');
        badge.className = 'badge';
        badge.textContent = `Hi, ${u.name.split(' ')[0]} üëã`;
        header.prepend(badge);
      } catch {}
    })();
  </script>
</body>
</html>
