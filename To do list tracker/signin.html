<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>FocusFlow â€” Sign In</title>
  <meta name="color-scheme" content="light dark"/>
  <link rel="stylesheet" href="auth.css"/>
</head>
<body class="light">
  <div class="auth glass" role="application" aria-label="Sign in">
    <div class="left">
      <h1 class="logo">Focus<span>Flow</span></h1>
      <h3 style="margin:0">Welcome back ğŸ‘‹</h3>
      <p class="pitch">Sign in to continue crafting your gradient-powered productivity.</p>
      <div class="feature"><span>ğŸ”’</span><div><b>Local-first</b><br><small>All demo data stays in your browser.</small></div></div>
      <div class="feature"><span>âš¡</span><div><b>Fast</b><br><small>Zero network roundtrips needed.</small></div></div>
    </div>

    <div class="right">
      <div class="row" style="justify-content:space-between">
        <div class="tabs" role="tablist">
          <button class="tab" aria-selected="true">Sign in</button>
          <a class="tab" href="signup.html" aria-selected="false">Create account</a>
        </div>
        <button id="theme-toggle" class="tab" title="Theme">ğŸŒ™</button>
      </div>

      <form id="form" autocomplete="on" novalidate>
        <div class="field">
          <label for="email">Email</label>
          <input id="email" class="input" type="email" placeholder="you@example.com" required/>
        </div>
        <div class="field rel">
          <label for="password">Password</label>
          <input id="password" class="input" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required/>
          <span class="showpass" role="button" aria-label="Show password" id="togglepass">ğŸ‘ï¸</span>
        </div>
        <div class="row">
          <label class="row" style="gap:6px">
            <input id="remember" type="checkbox"/> <span class="hint">Remember me</span>
          </label>
          <a href="#" id="forgot" class="hint">Forgot password?</a>
        </div>
        <div id="msg" class="error" aria-live="polite"></div>
        <div class="actions">
          <button class="btn primary" type="submit">Sign in</button>
          <a class="btn linklike" href="index.html">Back to app</a>
        </div>
        <div class="divider">or</div>
        <div class="actions" style="display:grid; grid-template-columns:1fr 1fr; gap:10px">
          <button class="btn oauth" type="button" id="oauth-google">â— Google (mock)</button>
          <button class="btn oauth" type="button" id="oauth-github">â—† GitHub (mock)</button>
        </div>
        <div class="footer">New here? <a href="signup.html">Create an account</a></div>
      </form>
    </div>
  </div>

  <script src="auth.js"></script>
  <script>
    window.addEventListener('DOMContentLoaded', () => {
      try {
        // Already authed? Go to app (prevents loop)
        if (FocusAuth.Session.isAuthed()) {
          window.location.replace('index.html');
          return;
        }

        // Fill remembered email
        const last = localStorage.getItem(FocusAuth.LAST_EMAIL_KEY);
        if (last) document.getElementById('email').value = last;

        // Toggle password
        document.getElementById('togglepass').addEventListener('click', ()=>{
          const i = document.getElementById('password');
          i.type = i.type === 'password' ? 'text' : 'password';
        });

        // Forgot (mock)
        document.getElementById('forgot').onclick = (e)=>{ e.preventDefault(); alert('Demo only: password reset not wired.'); };

        // OAuth (mock)
        document.getElementById('oauth-google').onclick = ()=> alert('Mock Google OAuth.');
        document.getElementById('oauth-github').onclick = ()=> alert('Mock GitHub OAuth.');

        // Submit
        document.getElementById('form').addEventListener('submit', async (e)=>{
          e.preventDefault();
          const email = document.getElementById('email').value.trim().toLowerCase();
          const pass  = document.getElementById('password').value;
          const keep  = document.getElementById('remember').checked;
          const msgEl = document.getElementById('msg');

          msgEl.className = 'error';
          msgEl.textContent = '';
          if (!/^\S+@\S+\.\S+$/.test(email)) { msgEl.textContent = 'Enter a valid email.'; return; }
          const user = FocusAuth.Users.get(email);
          if (!user) { msgEl.textContent = 'No account found for this email.'; return; }

          let hpw;
          try { hpw = await FocusAuth.sha256(pass); }
          catch (err) { console.error(err); msgEl.textContent = 'Unexpected error hashing password.'; return; }

          if (hpw !== user.hpw) { msgEl.textContent = 'Incorrect password.'; return; }

          FocusAuth.Session.set(keep);
          localStorage.setItem(FocusAuth.LAST_EMAIL_KEY, email);
          msgEl.className = 'success'; msgEl.textContent = 'Success! Redirectingâ€¦';
          setTimeout(()=> window.location.replace('index.html'), 350);
        });
      } catch (e) {
        console.error('Signin init error:', e);
        const m = document.getElementById('msg');
        if (m) m.textContent = 'Something went wrong initializing the page.';
      }
    });
  </script>
</body>
</html>
