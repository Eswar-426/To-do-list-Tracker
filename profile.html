<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>FocusFlow ‚Äî Profile</title>
  <meta name="color-scheme" content="light dark"/>
  <script>
    // Auth guard
    (function(){
      const hasToken = !!(localStorage.getItem('focusflow.auth.token') || sessionStorage.getItem('focusflow.auth.token'));
      if (!hasToken) location.replace('signin.html');
    })();
  </script>
  <link rel="stylesheet" href="auth.css"/>
  <style>
    /* --- Page layout & cards (reuses auth.css tokens) --- */
    body { padding: 16px; }
    .wrap { width: min(960px, 96vw); margin: 0 auto; display: grid; gap: 16px; }
    .header-bar { position: sticky; top: 12px; z-index: 85; display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .card { padding: clamp(18px, 3vw, 24px); }
    .grid { display:grid; gap:12px; }
    .two { grid-template-columns: 1fr 1fr; }
    @media (max-width: 720px){ .two{ grid-template-columns: 1fr; } }
    .row { display:flex; gap:10px; align-items:center; flex-wrap: wrap; }
    .avatar {
      width:64px; height:64px; border-radius: 16px;
      display:grid; place-items:center; font-weight:800;
      background: linear-gradient(135deg, rgba(124,58,237,.45), rgba(6,182,212,.45));
      border:1px solid rgba(255,255,255,.2); color:#fff;
    }
    .note { font-size:12px; color:var(--muted); }
    .success { color: var; /* will be set inline */ }
    .error   { color: var(--bad); font-size: 13px; }
    .btn.primary{ background-image: var(--gradient); color:#fff; }

    /* --- Non-blurry dropdown with overlay, high contrast --- */
    .overlay {
      position: fixed; inset: 0;
      background: rgba(0,0,0,.45); /* darker = clearer menu */
      backdrop-filter: blur(2px);
      -webkit-backdrop-filter: blur(2px);
      z-index: 88;
      pointer-events: auto;
    }
    .hidden { display:none !important; }

    .dropdown-wrap { position: relative; }
    .dropdown-menu {
      position: absolute;
      top: 44px;
      right: 0;                /* keep away from sidebar/content */
      min-width: 220px;
      max-height: min(60vh, 420px);
      overflow: auto;
      padding: 10px;
      display: grid; gap: 8px;
      z-index: 90;             /* above overlay & header */
      background: rgba(20, 24, 36, 0.92); /* solid glassy panel */
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.18);
      box-shadow: 0 24px 70px rgba(0,0,0,.5);
      backdrop-filter: none;   /* remove blur to avoid fuzzy text */
    }
    body.light .dropdown-menu { background: rgba(250,252,255,.98); }

    .dropdown-menu .item {
      display: flex; align-items: center; gap: 10px;
      padding: 10px 12px; border-radius: 10px; background: transparent;
      border: 1px solid transparent; cursor: pointer; text-align: left;
      color: var(--text);
    }
    .dropdown-menu .item:hover { background: var(--panel); border-color: rgba(255,255,255,.15); }
    .dropdown-menu .item:focus { outline: 2px solid var(--ring); }
    .dropdown-menu hr { border: 0; height: 1px; background: rgba(255,255,255,.15); }
    body.light .dropdown-menu .item:hover { background: rgba(0,0,0,.04); border-color: rgba(0,0,0,.08); }

    /* block background scroll when menu open */
    html.menu-open { overflow: hidden; }
  </style>
</head>
<body class="light">
  <div id="menu-overlay" class="overlay hidden" aria-hidden="true"></div>

  <header class="glass header-bar">
    <div class="dropdown-wrap">
      <button class="tab" id="menu-toggle" aria-haspopup="true" aria-expanded="false" aria-controls="dropdown-menu" aria-label="Open menu">‚ò∞</button>
      <nav class="dropdown-menu hidden" id="dropdown-menu" role="menu" aria-label="Main menu">
        <button class="item" role="menuitem" id="go-tasks">üóÇÔ∏è Tasks</button>
        <button class="item" role="menuitem" id="go-settings">‚öôÔ∏è Settings</button>
        <hr/>
        <button class="item" role="menuitem" id="logout-btn" style="color:#ef4444">üö™ Logout</button>
      </nav>
    </div>
    <h1 class="logo" style="margin:0">Focus<span>Flow</span> ‚Äî Profile</h1>
    <button id="theme-toggle" class="tab" title="Theme">üåô</button>
  </header>

  <main class="wrap" id="content">
    <section class="glass card">
      <div class="row" style="justify-content:space-between">
        <div class="row">
          <div class="avatar" id="avatar">FF</div>
          <div>
            <div id="greeting" style="font-weight:800; font-size:18px">Hi!</div>
            <div class="note">Manage your personal details.</div>
          </div>
        </div>
        <span id="msg" class="success" style="color: var(--ok);"></span>
      </div>

      <form id="profile-form" class="grid two" novalidate>
        <div class="field">
          <label for="name">Full name</label>
          <input id="name" class="input" type="text" required/>
        </div>
        <div class="field">
          <label for="email">Email</label>
          <input id="email" class="input" type="email" required/>
          <div class="note">Changing email updates your login email.</div>
        </div>
        <div class="field">
          <label>Member since</label>
          <input id="created" class="input" type="text" disabled/>
        </div>
        <div class="field">
          <label>Current session</label>
          <input id="session" class="input" type="text" disabled/>
        </div>
        <div class="row" style="grid-column: 1 / -1; justify-content:flex-end">
          <button type="submit" class="btn primary">Save changes</button>
        </div>
      </form>
    </section>

    <section class="glass card">
      <h3 style="margin-top:0">Change password</h3>
      <form id="password-form" class="grid two" novalidate>
        <div class="field">
          <label for="oldpw">Current password</label>
          <input id="oldpw" class="input" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required/>
        </div>
        <div class="field">
          <label for="newpw">New password</label>
          <input id="newpw" class="input" type="password" minlength="8" placeholder="At least 8 characters" required/>
        </div>
        <div class="field">
          <label for="confpw">Confirm new password</label>
          <input id="confpw" class="input" type="password" minlength="8" placeholder="Re-enter new password" required/>
        </div>
        <div class="row" style="grid-column: 1 / -1; justify-content:flex-end">
          <button type="submit" class="btn">Update password</button>
        </div>
        <div id="pwmsg" class="error" style="grid-column:1 / -1"></div>
      </form>
    </section>
  </main>

  <script src="auth.js"></script>
  <script>
    // theme toggle comes from auth.js
    // ---- Menu with overlay + focus trap (no overlap confusion) ----
    (function initMenu(){
      const html = document.documentElement;
      const toggle  = document.getElementById('menu-toggle');
      const menu    = document.getElementById('dropdown-menu');
      const overlay = document.getElementById('menu-overlay');

      const focusables = () => Array.from(menu.querySelectorAll('button.item'));
      let lastFocused = null;

      function open(){
        lastFocused = document.activeElement;
        menu.classList.remove('hidden');
        overlay.classList.remove('hidden');
        toggle.setAttribute('aria-expanded','true');
        html.classList.add('menu-open');
        // place focus on first item
        const f = focusables()[0]; if (f) f.focus();
      }
      function close(){
        menu.classList.add('hidden');
        overlay.classList.add('hidden');
        toggle.setAttribute('aria-expanded','false');
        html.classList.remove('menu-open');
        if (lastFocused) lastFocused.focus();
      }
      toggle.addEventListener('click', (e)=>{ e.stopPropagation(); menu.classList.contains('hidden')?open():close(); });
      overlay.addEventListener('click', close);
      document.addEventListener('keydown', e=>{
        if (menu.classList.contains('hidden')) return;
        if (e.key === 'Escape') { e.preventDefault(); return void close(); }
        if (e.key === 'Tab'){
          const els = focusables();
          if (!els.length) return;
          const i = els.indexOf(document.activeElement);
          if (e.shiftKey && (i === 0 || i === -1)) { els[els.length-1].focus(); e.preventDefault(); }
          else if (!e.shiftKey && i === els.length-1) { els[0].focus(); e.preventDefault(); }
        }
      });
      // routes
      document.getElementById('go-tasks').onclick   = ()=>{ close(); location.href='index.html'; };
      document.getElementById('go-settings').onclick= ()=>{ close(); location.href='settings.html'; };
      document.getElementById('logout-btn').onclick = ()=>{ close(); FocusAuth.Session.clear(); location.replace('signin.html'); };
    })();

    // ---- Load current user and bind forms ----
    const users = JSON.parse(localStorage.getItem('focusflow.auth.users')||'[]');
    const last  = localStorage.getItem('focusflow.auth.lastEmail');
    let user    = users.find(u=>u.email===last);
    if (!user) { location.replace('signin.html'); }

    const initials = (user.name||'F F').trim().split(/\s+/).map(s=>s[0]).slice(0,2).join('').toUpperCase();
    document.getElementById('avatar').textContent   = initials;
    document.getElementById('greeting').textContent = `Hi, ${user.name.split(' ')[0]} üëã`;
    document.getElementById('name').value           = user.name||'';
    document.getElementById('email').value          = user.email||'';
    document.getElementById('created').value        = user.createdAt ? new Date(user.createdAt).toLocaleString() : '‚Äî';
    document.getElementById('session').value        = (localStorage.getItem('focusflow.auth.token')||sessionStorage.getItem('focusflow.auth.token')||'‚Äî');

    document.getElementById('profile-form').addEventListener('submit', (e)=>{
      e.preventDefault();
      const msg = document.getElementById('msg'); msg.textContent=''; msg.style.color = 'var(--bad)';
      const name = document.getElementById('name').value.trim();
      const email= document.getElementById('email').value.trim().toLowerCase();
      if (name.length<2) { msg.textContent='Name too short.'; return; }
      if (!/^\S+@\S+\.\S+$/.test(email)) { msg.textContent='Invalid email.'; return; }
      if (email!==user.email && users.some(u=>u.email===email)) { msg.textContent='Email already in use.'; return; }
      user.name = name;
      if (email!==user.email){ user.email=email; localStorage.setItem('focusflow.auth.lastEmail', email); }
      localStorage.setItem('focusflow.auth.users', JSON.stringify(users));
      msg.style.color='var(--ok)'; msg.textContent='Saved ‚úî'; setTimeout(()=> msg.textContent='',1600);
    });

    document.getElementById('password-form').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const pwmsg = document.getElementById('pwmsg'); pwmsg.textContent='';
      const oldpw = document.getElementById('oldpw').value;
      const newpw = document.getElementById('newpw').value;
      const conf  = document.getElementById('confpw').value;
      const oldHash = await FocusAuth.sha256(oldpw);
      if (oldHash !== user.hpw) { pwmsg.textContent='Current password is incorrect.'; return; }
      if (newpw.length < 8) { pwmsg.textContent='New password must be at least 8 characters.'; return; }
      if (newpw !== conf) { pwmsg.textContent='Passwords do not match.'; return; }
      user.hpw = await FocusAuth.sha256(newpw);
      localStorage.setItem('focusflow.auth.users', JSON.stringify(users));
      pwmsg.className='success'; pwmsg.style.color='var(--ok)'; pwmsg.textContent='Password updated ‚úî';
      ['oldpw','newpw','confpw'].forEach(id=>document.getElementById(id).value='');
      setTimeout(()=> { pwmsg.textContent=''; pwmsg.className=''; }, 1600);
    });
  </script>
</body>
</html>
